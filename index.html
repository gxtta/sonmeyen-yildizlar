<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sönmeyen Yıldızlar - Dijital Anıt</title>

  <!-- TAILWIND -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- THREE.JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <!-- TWEEN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

  <!-- ICONS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #050000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #tooltip { 
      pointer-events: none; 
      transform: translate(-50%, -150%); 
      z-index: 40; 
    }

    body.selection-active canvas { 
      cursor: crosshair !important; 
    }

    .pulse-border {
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 0 rgba(219, 39, 119, 0.7);
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(219, 39, 119, 0); }
      100% { box-shadow: 0 0 0 0 rgba(219, 39, 119, 0); }
    }
  </style>

</head>

<body class="antialiased text-gray-100">

<!-- CANVAS -->
<canvas id="webgl" class="absolute top-0 left-0 w-full h-full"></canvas>


<!-- LOADING -->
<div id="loading-overlay" class="absolute top-0 left-0 w-full h-full bg-black flex flex-col items-center justify-center text-white text-xl z-50">
  <div class="mb-4 animate-pulse text-pink-400 font-bold text-3xl">Sönmeyen Yıldızlar</div>
  <div class="text-gray-300">Yükleniyor...</div>
</div>


<!-- TOOLTIP -->
<div id="tooltip" class="absolute hidden bg-black/80 px-3 py-2 rounded-lg border border-white/10 text-sm">
  <div id="tooltip-name" class="font-bold text-pink-300"></div>
  <div id="tooltip-date" class="text-xs text-gray-300"></div>
</div>


<!-- DETAY PANEL -->
<div id="detail-panel" class="fixed right-0 top-0 h-full w-96 bg-black/70 backdrop-blur-lg border-l border-white/10 p-6 translate-x-full transition-all duration-300 overflow-y-auto z-40">

  <button id="close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl">
    <i class="fa-solid fa-xmark"></i>
  </button>

  <h2 id="panel-name" class="text-2xl font-bold mb-1 text-white"></h2>
  <p id="panel-date-head" class="text-gray-400 mb-4"></p>

  <div class="space-y-4 pt-4">

    <div class="detail-row">
      <span class="detail-label">Konum:</span>
      <span id="det-location" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Yaş:</span>
      <span id="det-age" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Fail:</span>
      <span id="det-killer" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Sebep:</span>
      <span id="det-reason" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Yöntem:</span>
      <span id="det-method" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Koruma Talebi:</span>
      <span id="det-protection" class="detail-value"></span>
    </div>

    <div class="detail-row">
      <span class="detail-label">Hukuki Durum:</span>
      <span id="det-status" class="detail-value"></span>
    </div>

    <div id="source-box" class="mt-4">
      <a id="source-link" href="#" target="_blank" class="text-pink-400 underline text-sm"></a>
    </div>

    <div class="mt-6">
      <label class="text-gray-300 text-sm mb-2 block">Bu kişi için bir not bırak:</label>
      <textarea id="memory-input" class="w-full h-24 bg-black/40 border border-white/10 p-3 rounded"></textarea>
      <button id="save-btn" class="mt-2 w-full bg-pink-600 hover:bg-pink-700 py-2 rounded">Kaydet</button>
      <div id="save-msg" class="hidden text-green-400 text-sm mt-2">Kaydedildi.</div>
    </div>

  </div>
</div>


<!-- ÜST BAR -->
<div class="fixed top-0 left-0 w-full p-4 flex justify-between items-center pointer-events-none z-30">

  <!-- SOL -->
  <div class="pointer-events-auto flex items-center gap-4">
    <div class="bg-black/60 px-4 py-2 rounded-lg border border-white/10">
      Toplam: <span id="total-count" class="font-bold text-pink-400">0</span> kişi
    </div>

    <div class="relative">
      <input id="search-input" class="bg-black/50 border border-white/20 px-3 py-2 rounded-lg w-64" 
             placeholder="İsim ara...">
      <div id="search-results"
           class="absolute top-full left-0 w-full bg-black/80 border border-white/10 rounded-lg mt-1 hidden max-h-64 overflow-y-auto"></div>
    </div>
  </div>

  <!-- SAĞ -->
  <div class="pointer-events-auto flex items-center gap-4">

    <button id="toggle-selection-mode"
            class="bg-black/60 border border-gray-500 text-gray-300 px-4 py-2 rounded-lg flex items-center gap-2">
      <i class="fa-solid fa-crosshairs"></i>
      <span>Seçim Modu:</span>
      <span id="mode-text" class="font-bold">KAPALI</span>
      <span id="mode-indicator" class="ml-2 w-3 h-3 bg-pink-500 rounded-full opacity-0 transition-all"></span>
    </button>

  </div>
</div>


<script>
/*====================================================================
  GLOBAL
====================================================================*/
let namesList = [];
let points = null;
let geometry = null;

let isSelectionMode = false;

const canvas = document.getElementById("webgl");

/*====================================================================
  MODAL / PANEL ELEMENTLERİ
====================================================================*/
const detailPanel = document.getElementById("detail-panel");
const tooltip = document.getElementById("tooltip");
const tooltipName = document.getElementById("tooltip-name");
const tooltipDate = document.getElementById("tooltip-date");

const panelEls = {
  name: document.getElementById("panel-name"),
  dateHead: document.getElementById("panel-date-head"),
  location: document.getElementById("det-location"),
  age: document.getElementById("det-age"),
  killer: document.getElementById("det-killer"),
  reason: document.getElementById("det-reason"),
  method: document.getElementById("det-method"),
  protection: document.getElementById("det-protection"),
  status: document.getElementById("det-status"),
  sourceLink: document.getElementById("source-link"),
  input: document.getElementById("memory-input"),
  saveMsg: document.getElementById("save-msg")
};

let currentSelectedName = null;


/*====================================================================
  ÜÇ BOYUTLU SAHNE
====================================================================*/
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2("#050000", 0.03);

const camera = new THREE.PerspectiveCamera(
  75, window.innerWidth / window.innerHeight, 0.1, 100
);
camera.position.set(0, 4, 8);

const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.6;


/*====================================================================
  YÜREK DOKUSU
====================================================================*/
function createHeartTexture() {
  const c = document.createElement("canvas");
  c.width = 32;
  c.height = 32;
  const ctx = c.getContext("2d");

  ctx.fillStyle = "#ffffff";
  ctx.beginPath();
  ctx.moveTo(16, 28);
  ctx.bezierCurveTo(16, 26, 4, 18, 4, 12);
  ctx.bezierCurveTo(4, 6, 10, 4, 16, 10);
  ctx.bezierCurveTo(22, 4, 28, 6, 28, 12);
  ctx.bezierCurveTo(28, 18, 16, 26, 16, 28);
  ctx.fill();

  ctx.shadowBlur = 6;
  ctx.shadowColor = "white";
  ctx.fill();

  return new THREE.CanvasTexture(c);
}


/*====================================================================
  GALAKSİ OLUŞTURMA
====================================================================*/
function generateGalaxy() {
  const count = namesList.length;
  document.getElementById("total-count").innerText = count;

  geometry = new THREE.BufferGeometry();
  const positions = new Float32Array(count * 3);
  const colors = new Float32Array(count * 3);
  const nameIndex = new Float32Array(count);

  const c1 = new THREE.Color("#ffc0cb");
  const c2 = new THREE.Color("#8a0000");

  for (let i = 0; i < count; i++) {
    const i3 = i * 3;

    const r = Math.pow(i / count, 0.7) * 12;
    const swirl = r * 1.3;
    const b = (i % 5) / 5 * Math.PI * 2;

    positions[i3] = Math.cos(b + swirl) * r + (Math.random() - 0.5) * r * 0.4;
    positions[i3 + 1] = (Math.random() - 0.5) * r * 0.25;
    positions[i3 + 2] = Math.sin(b + swirl) * r + (Math.random() - 0.5) * r * 0.4;

    const mixed = c1.clone().lerp(c2, r / 12);
    colors[i3] = mixed.r;
    colors[i3 + 1] = mixed.g;
    colors[i3 + 2] = mixed.b;

    nameIndex[i] = i;
  }

  geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
  geometry.setAttribute("color", new THREE.BufferAttribute(colors, 3));
  geometry.setAttribute("nameIndex", new THREE.BufferAttribute(nameIndex, 1));

  const material = new THREE.PointsMaterial({
    size: 0.25,
    sizeAttenuation: true,
    depthWrite: false,
    blending: THREE.AdditiveBlending,
    vertexColors: true,
    map: createHeartTexture(),
    transparent: true
  });

  points = new THREE.Points(geometry, material);
  scene.add(points);
}


/*====================================================================
  VERİ ÇEKME
====================================================================*/
async function fetchNames() {
  try {
    const r = await fetch("anit_verileri.json?t=" + Date.now());
    namesList = await r.json();
  } catch {
    namesList = [
      { name: "Özgecan Aslan", date: "2015", location: "Mersin", killer: "Bilinmiyor" },
      { name: "Emine Bulut", date: "2019", location: "Kırıkkale", killer: "Eski eşi" }
    ];
  }

  generateGalaxy();
  document.getElementById("loading-overlay").style.opacity = 0;
  setTimeout(() => {
    document.getElementById("loading-overlay").style.display = "none";
  }, 1200);
}


/*====================================================================
  RAYCASTER
====================================================================*/
const raycaster = new THREE.Raycaster();
raycaster.params.Points.threshold = 0.6;
const mouse = new THREE.Vector2();


/*====================================================================
  HOVER (TOOLTIP)
====================================================================*/
window.addEventListener("mousemove", (e) => {
  if (!points) return;

  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const hit = raycaster.intersectObject(points);

  if (hit.length > 0) {
    const index = hit[0].index;
    const real = geometry.attributes.nameIndex.array[index];
    const p = namesList[real];

    tooltipName.innerText = p.name;
    tooltipDate.innerText = p.date || "";

    tooltip.style.left = e.clientX + 15 + "px";
    tooltip.style.top = e.clientY + 15 + "px";
    tooltip.classList.remove("hidden");

    document.body.style.cursor = isSelectionMode ? "crosshair" : "pointer";

  } else {
    tooltip.classList.add("hidden");
    document.body.style.cursor = isSelectionMode ? "crosshair" : "default";
  }
});


/*====================================================================
  SEÇİM MODU CLICK (TIKLAMA)
====================================================================*/
let pointerDown = false;
let pointerMoved = false;
let downX = 0, downY = 0;

canvas.addEventListener("pointerdown", (e) => {
  pointerDown = true;
  pointerMoved = false;
  downX = e.clientX;
  downY = e.clientY;
});

canvas.addEventListener("pointermove", (e) => {
  if (!pointerDown) return;
  if (Math.abs(e.clientX - downX) > 5 || Math.abs(e.clientY - downY) > 5) {
    pointerMoved = true;
  }
});

canvas.addEventListener("pointerup", () => {
  pointerDown = false;
  pointerMoved = false;
});

canvas.addEventListener("click", (e) => {
  if (!isSelectionMode) return;
  if (pointerMoved) return;

  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const hit = raycaster.intersectObject(points);

  if (hit.length > 0) {
    const index = hit[0].index;
    const real = geometry.attributes.nameIndex.array[index];

    openPanel(real);
    flyToStar(index);
  }
});


/*====================================================================
  PANEL AÇMA
====================================================================*/
function openPanel(index) {
  const p = namesList[index];
  currentSelectedName = p.name;

  const safe = (v) => v ? v : "Bilinmiyor";

  panelEls.name.innerText = p.name;
  panelEls.dateHead.innerText = safe(p.date);
  panelEls.location.innerText = safe(p.location);
  panelEls.age.innerText = safe(p.age);
  panelEls.killer.innerText = safe(p.killer);
  panelEls.reason.innerText = safe(p.reason);
  panelEls.method.innerText = safe(p.method);
  panelEls.protection.innerText = safe(p.protection);
  panelEls.status.innerText = safe(p.status);

  if (p.source) {
    panelEls.sourceLink.href = p.source;
    panelEls.sourceLink.innerText = "Kaynak bağlantısı";
  } else {
    panelEls.sourceLink.innerText = "";
  }

  panelEls.input.value = localStorage.getItem("note_" + p.name) || "";

  detailPanel.classList.remove("translate-x-full");
  controls.autoRotate = false;
}

document.getElementById("close-btn").onclick = () => {
  detailPanel.classList.add("translate-x-full");
  controls.autoRotate = true;
};


/*====================================================================
  KAMERA UÇUŞU
====================================================================*/
function flyToStar(index) {
  const pos = geometry.attributes.position.array;
  const target = new THREE.Vector3(
    pos[index * 3],
    pos[index * 3 + 1],
    pos[index * 3 + 2]
  );

  const camTarget = target.clone().add(new THREE.Vector3(0, 0.5, 2));

  new TWEEN.Tween(camera.position)
    .to({ x: camTarget.x, y: camTarget.y, z: camTarget.z }, 1000)
    .easing(TWEEN.Easing.Cubic.Out)
    .start();

  new TWEEN.Tween(controls.target)
    .to({ x: target.x, y: target.y, z: target.z }, 1000)
    .easing(TWEEN.Easing.Cubic.Out)
    .start();
}


/*====================================================================
  NOT KAYDETME
====================================================================*/
document.getElementById("save-btn").onclick = () => {
  if (!currentSelectedName) return;

  localStorage.setItem("note_" + currentSelectedName, panelEls.input.value);

  panelEls.saveMsg.classList.remove("hidden");
  setTimeout(() => panelEls.saveMsg.classList.add("hidden"), 1500);
};


/*====================================================================
  SEÇİM MODU BUTONU
====================================================================*/
document.getElementById("toggle-selection-mode").onclick = () => {
  isSelectionMode = !isSelectionMode;

  const btn = document.getElementById("toggle-selection-mode");
  const text = document.getElementById("mode-text");
  const ind = document.getElementById("mode-indicator");

  if (isSelectionMode) {
    text.innerText = "AÇIK";
    ind.style.opacity = 1;
    btn.classList.add("pulse-border");
    document.body.classList.add("selection-active");
  } else {
    text.innerText = "KAPALI";
    ind.style.opacity = 0;
    btn.classList.remove("pulse-border");
    document.body.classList.remove("selection-active");
  }
};


/*====================================================================
  ARAMA
====================================================================*/
const searchInput = document.getElementById("search-input");
const searchResults = document.getElementById("search-results");

searchInput.addEventListener("input", () => {
  const q = searchInput.value.toLowerCase();
  searchResults.innerHTML = "";

  if (q.length < 2) {
    searchResults.classList.add("hidden");
    return;
  }

  const found = namesList
    .map((p, i) => ({ ...p, index: i }))
    .filter(p => p.name.toLowerCase().includes(q))
    .slice(0, 10);

  if (found.length === 0) {
    searchResults.innerHTML =
      '<div class="px-3 py-2 text-gray-400 text-sm">Sonuç yok</div>';
    searchResults.classList.remove("hidden");
    return;
  }

  found.forEach(p => {
    const div = document.createElement("div");
    div.className =
      "px-3 py-2 hover:bg-white/10 cursor-pointer text-sm border-b border-white/10";
    div.innerText = p.name;
    div.onclick = () => {
      openPanel(p.index);
      flyToStar(p.index);
      searchResults.classList.add("hidden");
      searchInput.value = "";
    };
    searchResults.appendChild(div);
  });

  searchResults.classList.remove("hidden");
});

document.addEventListener("click", (e) => {
  if (!searchInput.contains(e.target)) {
    searchResults.classList.add("hidden");
  }
});


/*====================================================================
  EKRAN YENİDEN BOYUTLANDI
====================================================================*/
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});


/*====================================================================
  ANİMASYON
====================================================================*/
function tick() {
  TWEEN.update();
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(tick);
}


/*====================================================================
  BAŞLAT
====================================================================*/
fetchNames();
tick();

</script>

</body>
</html>
